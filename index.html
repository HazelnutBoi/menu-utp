<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Menú UTP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --utp-purple: #6a0dad;
      }
      .header-bg {
        background: var(--utp-purple);
      }
      .hidden {
        display: none;
      }
    </style>
</head>
<body class="font-roboto bg-gray-100 text-gray-800">
    <header class="header-bg text-white py-4 text-center flex items-center justify-center shadow-md mb-8">
      <img src="logo_utp.png" alt="Logo UTP" class="h-12 mr-4">
      <h2 class="text-2xl font-bold">Menú UTP</h2>
    </header>

    <div class="px-5 max-w-4xl mx-auto">
      <div id="loading" class="text-center text-xl text-gray-500">
        Cargando menú...
      </div>
      
      <table id="menuTable" class="hidden w-full border-collapse my-5 shadow-lg bg-white rounded-lg overflow-hidden">
          <thead>
              <tr>
                  <th class="p-4 border border-gray-200 text-left text-white uppercase font-bold text-lg" style="background-color: var(--utp-purple);">Descripción</th>
                  <th class="p-4 border border-gray-200 text-left text-white uppercase font-bold text-lg" style="background-color: var(--utp-purple);">Precio</th>
              </tr>
          </thead>
          <tbody>
          </tbody>
      </table>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Leer las variables de entorno para la configuración
        const firebaseConfig = {
          apiKey: "%FIREBASE_API_KEY%",
          authDomain: "%FIREBASE_AUTH_DOMAIN%",
          databaseURL: "%FIREBASE_DATABASE_URL%",
          projectId: "%FIREBASE_PROJECT_ID%",
          storageBucket: "%FIREBASE_STORAGE_BUCKET%",
          messagingSenderId: "%FIREBASE_MESSAGING_SENDER_ID%",
          appId: "%FIREBASE_APP_ID%",
          measurementId: "%FIREBASE_MEASUREMENT_ID%"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const menuTableBody = document.querySelector("#menuTable tbody");
        const loadingMessage = document.getElementById("loading");
        const menuTable = document.getElementById("menuTable");

        function renderMenu(items) {
          menuTableBody.innerHTML = "";
          if (items && items.length > 0) {
            items.forEach(item => {
                const formattedPrice = "B/. " + item.precio;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td class="p-4 border border-gray-200 text-lg">${item.descripcion}</td>
                    <td class="p-4 border border-gray-200 text-lg">${formattedPrice}</td>
                `;
                menuTableBody.appendChild(row);
            });
            loadingMessage.classList.add("hidden");
            menuTable.classList.remove("hidden");
          } else {
            loadingMessage.textContent = "El menú de hoy no está disponible.";
            loadingMessage.classList.remove("hidden");
            menuTable.classList.add("hidden");
          }
        }

        const cachedMenu = localStorage.getItem("menuCache");
        if (cachedMenu) {
            const data = JSON.parse(cachedMenu);
            renderMenu(data.items);
        }

        db.ref("menuHoy").on("value", (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                renderMenu(data.items);
                localStorage.setItem("menuCache", JSON.stringify(data));
            } else {
                renderMenu([]);
            }
        });

        try {
            fetch("/api/track-view", { method: "POST" });
        } catch (error) {
            console.error("Error al registrar la visita");
        }
    </script>
</body>
</html>
