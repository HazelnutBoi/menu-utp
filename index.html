<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Menú UTP CRPO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --utp-purple: #6a0dad;
      }
      .header-bg {
        background: var(--utp-purple);
      }
      .hidden {
        display: none;
      }
    </style>
</head>
<body class="font-roboto bg-gray-100 text-gray-800" onunload="detachListener()">
    <header class="header-bg text-white py-4 text-center flex flex-col items-center justify-center shadow-md mb-8">
      <div class="flex items-center justify-center">
        <img src="logo_utp.png" alt="Logo UTP" class="h-12 mr-4">
        <h2 class="text-2xl font-bold">Menú UTP</h2>
      </div>
      <h3 id="fechaHoy" class="text-white text-md mt-2"></h3>
    </header>

    <div class="px-5 max-w-4xl mx-auto">
      <div id="loading" class="text-center text-xl text-gray-500">
        Cargando menú...
      </div>
      
      <table id="menuTable" class="hidden w-full border-collapse my-5 shadow-lg bg-white rounded-lg overflow-hidden">
          <thead>
              <tr>
                  <th class="p-4 border border-gray-200 text-left text-white uppercase font-bold text-lg" style="background-color: var(--utp-purple);">Descripción</th>
                  <th class="p-4 border border-gray-200 text-left text-white uppercase font-bold text-lg" style="background-color: var(--utp-purple);">Precio</th>
              </tr>
          </thead>
          <tbody>
          </tbody>
      </table>
      
      <h3 id="upcomingHeader" class="text-2xl font-bold text-gray-800 mt-8 mb-2 hidden">Próximamente</h3>
      <table id="upcomingMenuTable" class="hidden w-full border-collapse my-5 shadow-lg bg-white rounded-lg overflow-hidden">
          <thead>
              <tr>
                  <th class="p-4 border border-gray-200 text-left text-white uppercase font-bold text-lg" style="background-color: var(--utp-purple);">Descripción</th>
                  <th class="p-4 border border-gray-200 text-left text-white uppercase font-bold text-lg" style="background-color: var(--utp-purple);">Tiempo restante / Precio</th>
              </tr>
          </thead>
          <tbody>
          </tbody>
      </table>
    </div>

    <div class="text-center mt-8 mb-8">
      <a href="https://forms.office.com/r/4VTptYVr4k?origin=lprLink" target="_blank" class="text-lg font-bold text-gray-600 hover:text-utp-purple transition-colors duration-300">
        ¿Tienes alguna sugerencia? ¡Escríbenos!
      </a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const menuTableBody = document.querySelector("#menuTable tbody");
        const upcomingMenuTableBody = document.querySelector("#upcomingMenuTable tbody");
        const loadingMessage = document.getElementById("loading");
        const menuTable = document.getElementById("menuTable");
        const upcomingMenuTable = document.getElementById("upcomingMenuTable");
        const upcomingHeader = document.getElementById("upcomingHeader");
        const fechaHoyElement = document.getElementById("fechaHoy");
        let db;
        let listener;
        let countdownInterval;

        function displayCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date().toLocaleDateString('es-ES', options);
            fechaHoyElement.textContent = `Hoy, ${today}`;
        }
        
        async function initializeFirebase() {
            try {
                const response = await fetch('/api/firebase-config');
                const firebaseConfig = await response.json();
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                displayCurrentDate();
                loadMenu();
                
                try {
                    fetch("/api/track-view", { method: "POST" });
                } catch (error) {
                    console.error("Error al registrar la visita");
                }
            } catch (error) {
                console.error("Error al obtener la configuración de Firebase:", error);
                loadingMessage.textContent = "Error al cargar el menú.";
            }
        }
        
        function formatRemainingTime(milliseconds) {
            const totalSeconds = Math.max(0, Math.floor(milliseconds / 1000));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds} s`;
        }
        
        function updateUpcomingTimers() {
            const rows = upcomingMenuTableBody.querySelectorAll("tr");
            rows.forEach(row => {
                const endTime = parseInt(row.dataset.endtime);
                const remaining = endTime - Date.now();
                const timeCell = row.querySelector("td:nth-child(2)");

                if (remaining > 0) {
                    const price = row.dataset.price;
                    timeCell.innerHTML = `<div>${formatRemainingTime(remaining)}</div><div class="font-bold">B/. ${price}</div>`;
                } else {
                    const price = row.dataset.price;
                    timeCell.innerHTML = `<div>¡Listo!</div><div class="font-bold">B/. ${price}</div>`;
                }
            });
        }
        
        function renderMenu(items, tableBody) {
          tableBody.innerHTML = "";
          if (items && items.length > 0) {
            items.forEach(item => {
                const row = document.createElement("tr");
                if (item.esProximo) {
                    row.dataset.endtime = item.readyAt;
                    row.dataset.price = parseFloat(item.precio).toFixed(2);
                    row.innerHTML = `
                        <td class="p-4 border border-gray-200 text-lg">${item.descripcion}</td>
                        <td class="p-4 border border-gray-200 text-lg">Cargando...</td>
                    `;
                } else {
                    const formattedPrice = "B/. " + parseFloat(item.precio).toFixed(2);
                    row.innerHTML = `
                        <td class="p-4 border border-gray-200 text-lg">${item.descripcion}</td>
                        <td class="p-4 border border-gray-200 text-lg">${formattedPrice}</td>
                    `;
                }
                tableBody.appendChild(row);
            });
          } else {
             tableBody.innerHTML = "";
          }
        }
        
        function loadMenu() {
            const menuRef = db.collection("menus").doc("menuHoy");
            listener = menuRef.onSnapshot((docSnapshot) => {
                if (docSnapshot.exists) {
                    const allItems = docSnapshot.data().items || [];
                    
                    const readyItems = allItems.filter(item => !item.esProximo);
                    const upcomingItems = allItems.filter(item => item.esProximo);
                    
                    renderMenu(readyItems, menuTableBody);
                    renderMenu(upcomingItems, upcomingMenuTableBody);
                    
                    if (countdownInterval) {
                      clearInterval(countdownInterval);
                    }
                    if (upcomingItems.length > 0) {
                      updateUpcomingTimers();
                      countdownInterval = setInterval(updateUpcomingTimers, 1000);
                    } else {
                      clearInterval(countdownInterval);
                    }

                    if (readyItems.length > 0) {
                      menuTable.classList.remove("hidden");
                    } else {
                      menuTable.classList.add("hidden");
                    }
                    if (upcomingItems.length > 0) {
                      upcomingMenuTable.classList.remove("hidden");
                      upcomingHeader.classList.remove("hidden");
                    } else {
                      upcomingMenuTable.classList.add("hidden");
                      upcomingHeader.classList.add("hidden");
                    }
                    
                    loadingMessage.classList.add("hidden");
                } else {
                    renderMenu([], menuTableBody);
                    renderMenu([], upcomingMenuTableBody);
                    loadingMessage.textContent = "El menú de hoy no está disponible.";
                    loadingMessage.classList.remove("hidden");
                }
            });
        }
        
        function detachListener() {
          if (listener) {
            listener();
          }
        }
        
        initializeFirebase();
    </script>
</body>
</html>

