<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Menú UTP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --utp-purple: #6a0dad;
      }
      .header-bg {
        background: var(--utp-purple);
      }
      .hidden {
        display: none;
      }
    </style>
</head>
<body class="font-roboto bg-gray-100 text-gray-800">
    <header class="header-bg text-white py-4 text-center flex items-center justify-center shadow-md mb-8">
      <img src="logo_utp.png" alt="Logo UTP" class="h-12 mr-4">
      <h2 class="text-2xl font-bold">Menú UTP</h2>
    </header>

    <div class="px-5 max-w-4xl mx-auto">
      <div id="loading" class="text-center text-xl text-gray-500">
        Cargando menú...
      </div>
      
      <table id="menuTable" class="hidden w-full border-collapse my-5 shadow-lg bg-white rounded-lg overflow-hidden">
          <thead>
              <tr>
                  <th class="p-4 border border-gray-200 text-left text-white uppercase font-bold text-lg" style="background-color: var(--utp-purple);">Descripción</th>
                  <th class="p-4 border border-gray-200 text-left text-white uppercase font-bold text-lg" style="background-color: var(--utp-purple);">Precio</th>
              </tr>
          </thead>
          <tbody>
          </tbody>
      </table>
    </div>

    <div class="text-center mt-8 mb-8">
      <a href="https://forms.office.com/r/GzwCw7iFhK?origin=lprLink" target="_blank" class="text-lg font-bold text-gray-600 hover:text-utp-purple transition-colors duration-300">
        ¿Tienes alguna sugerencia? ¡Escríbenos!
      </a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        const menuTableBody = document.querySelector("#menuTable tbody");
        const loadingMessage = document.getElementById("loading");
        const menuTable = document.getElementById("menuTable");
        let db;

        async function initializeFirebase() {
            try {
                const response = await fetch('/api/firebase-config');
                const firebaseConfig = await response.json();
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                
                loadMenu();
                
                try {
                    fetch("/api/track-view", { method: "POST" });
                } catch (error) {
                    console.error("Error al registrar la visita");
                }
            } catch (error) {
                console.error("Error al obtener la configuración de Firebase:", error);
                loadingMessage.textContent = "Error al cargar el menú.";
            }
        }
        
        function renderMenu(items) {
          menuTableBody.innerHTML = "";
          if (items && items.length > 0) {
            items.forEach(item => {
                const formattedPrice = "B/. " + item.precio;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td class="p-4 border border-gray-200 text-lg">${item.descripcion}</td>
                    <td class="p-4 border border-gray-200 text-lg">${formattedPrice}</td>
                `;
                menuTableBody.appendChild(row);
            });
            loadingMessage.classList.add("hidden");
            menuTable.classList.remove("hidden");
          } else {
            loadingMessage.textContent = "El menú de hoy no está disponible.";
            loadingMessage.classList.remove("hidden");
            menuTable.classList.add("hidden");
          }
        }

        function loadMenu() {
            db.ref("menuHoy").on("value", (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    renderMenu(data.items);
                } else {
                    renderMenu([]);
                }
            });
        }
        
        initializeFirebase();
    </script>
</body>
</html>
